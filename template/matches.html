{% extends "base.html" %}

{% block title %}Mes Matches - Meet{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- En-t√™te -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-900 mb-4">Mes Matches</h1>
            <p class="text-gray-600">D√©couvrez les personnes avec qui vous avez cr√©√© une connexion</p>
            <div class="mt-4">
                <span class="bg-primary text-white px-4 py-2 rounded-full text-sm font-medium">
                    {{ matches|length }} match{{ 'es' if matches|length > 1 else '' }}
                </span>
            </div>
        </div>
    </div>

    {% if matches %}
    <!-- Grille des matches -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for match in matches %}
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition duration-300">
            <!-- Photo de profil -->
            <div class="relative h-48 bg-gray-200">
                {% if match.user.profile_photo %}
                <img src="{{ url_for('static', filename='uploads/' + match.user.profile_photo) }}" 
                     alt="Photo de {{ match.user.first_name }}" 
                     class="w-full h-full object-cover">
                {% else %}
                <div class="w-full h-full flex items-center justify-center">
                    <i class="fas fa-user text-6xl text-gray-400"></i>
                </div>
                {% endif %}
                
                <!-- Badge de match -->
                <div class="absolute top-3 left-3 bg-primary text-white px-3 py-1 rounded-full text-xs font-medium">
                    <i class="fas fa-heart mr-1"></i>Match
                </div>
                
                <!-- Date du match -->
                <div class="absolute top-3 right-3 bg-white bg-opacity-90 px-2 py-1 rounded-full text-xs font-medium text-gray-700">
                    {{ match.match_date|timeago }}
                </div>
            </div>
            
            <!-- Informations du profil -->
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-900">
                        {{ match.user.first_name }}, {{ match.user.age }}
                    </h3>
                    <span class="text-gray-500 text-sm">
                        <i class="fas fa-map-marker-alt mr-1"></i>{{ match.user.city }}
                    </span>
                </div>
                
                {% if match.user.bio %}
                <p class="text-gray-600 text-sm mb-4 min-h-[2.5rem] line-clamp-2">{{ match.user.bio }}</p>
                {% else %}
                <div class="mb-4 min-h-[2.5rem]"></div>
                {% endif %}
                
                <!-- Centres d'int√©r√™t -->
                {% if match.user.interests %}
                <div class="flex flex-wrap gap-2 mb-4">
                    {% for interest in match.user.interests[:3] %}
                    <span class="bg-primary bg-opacity-10 text-primary text-xs px-2 py-1 rounded-full">
                        {{ interest.name }}
                    </span>
                    {% endfor %}
                    {% if match.user.interests|length > 3 %}
                    <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">
                        +{{ match.user.interests|length - 3 }}
                    </span>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Dernier message -->
                {% if match.last_message %}
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                    <p class="text-sm text-gray-600 mb-1">
                        <strong>{{ 'Vous' if match.last_message.sender_id == current_user.id else match.user.first_name }}:</strong>
                    </p>
                    <p class="text-sm text-gray-800 line-clamp-2">{{ match.last_message.content }}</p>
                    <p class="text-xs text-gray-500 mt-2">
                        {{ match.last_message.created_at|timeago }}
                        {% if match.last_message.sender_id == current_user.id %}
                        <span class="ml-2 text-orange-500">
                            <i class="fas fa-clock mr-1"></i>
                            Expire dans {{ match.last_message.time_until_expiry }}
                        </span>
                        {% endif %}
                    </p>
                </div>
                {% endif %}
                
                <!-- Actions -->
                <div class="flex space-x-3">
                    <a href="{{ url_for('messages', user=match.user.id) }}" 
                       class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-dark transition duration-300 text-center">
                        <i class="fas fa-envelope mr-2"></i>Message
                    </a>
                    <button onclick="viewProfile({{ match.user.id }})" 
                            class="bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition duration-300">
                        <i class="fas fa-user"></i>
                    </button>
                    <button onclick="unmatch({{ match.user.id }})" 
                            class="bg-red-100 text-red-600 py-2 px-4 rounded-lg hover:bg-red-200 transition duration-300">
                        <i class="fas fa-user-times"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    

    
    {% else %}
    <!-- Aucun match -->
    <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
        <div class="text-6xl text-gray-300 mb-6">
            <i class="fas fa-heart-broken"></i>
        </div>
        <h3 class="text-2xl font-semibold text-gray-600 mb-4">Aucun match pour le moment</h3>
        <p class="text-gray-500 mb-8">
            Continuez √† d√©couvrir des profils et √† liker ceux qui vous int√©ressent. 
            Les matches se cr√©ent quand l'int√©r√™t est mutuel !
        </p>
        
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="{{ url_for('dashboard') }}" 
               class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-dark transition duration-300">
                <i class="fas fa-search mr-2"></i>D√©couvrir des profils
            </a>
            
            <a href="{{ url_for('profile', user_id=current_user.id) }}" 
               class="border-2 border-primary text-primary px-6 py-3 rounded-lg hover:bg-primary hover:text-white transition duration-300">
                <i class="fas fa-user-edit mr-2"></i>Am√©liorer mon profil
            </a>
        </div>
        
        <!-- Conseils pour am√©liorer les chances de match -->
        <div class="mt-12 bg-gray-50 rounded-lg p-6">
            <h4 class="text-lg font-semibold text-gray-900 mb-4">üí° Conseils pour plus de matches</h4>
            <div class="grid md:grid-cols-2 gap-4 text-left">
                <div>
                    <h5 class="font-medium text-gray-800 mb-2">üì∏ Photos de qualit√©</h5>
                    <p class="text-sm text-gray-600">Ajoutez des photos claires et r√©centes qui vous repr√©sentent bien</p>
                </div>
                <div>
                    <h5 class="font-medium text-gray-800 mb-2">‚úçÔ∏è Bio attractive</h5>
                    <p class="text-sm text-gray-600">R√©digez une bio int√©ressante qui donne envie d'en savoir plus</p>
                </div>
                <div>
                    <h5 class="font-medium text-gray-800 mb-2">üéØ Centres d'int√©r√™t</h5>
                    <p class="text-sm text-gray-600">S√©lectionnez des centres d'int√©r√™t vari√©s pour √©largir vos possibilit√©s</p>
                </div>
                <div>
                    <h5 class="font-medium text-gray-800 mb-2">üîÑ Activit√© r√©guli√®re</h5>
                    <p class="text-sm text-gray-600">Connectez-vous r√©guli√®rement pour √™tre visible dans les suggestions</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de profil rapide -->
<div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
        <div class="text-center">
            <div id="profile-photo" class="w-24 h-24 rounded-full mx-auto mb-4 bg-gray-200"></div>
            <h3 id="profile-name" class="text-xl font-bold text-gray-900 mb-2"></h3>
            <p id="profile-age-city" class="text-gray-600 mb-4"></p>
            <p id="profile-bio" class="text-gray-700 mb-4"></p>
            <div id="profile-interests" class="flex flex-wrap gap-2 justify-center mb-4"></div>
            <button onclick="closeProfileModal()" class="bg-primary text-white px-6 py-2 rounded-lg">
                Fermer
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function viewProfile(userId) {
    // Charger les informations du profil et afficher le modal
    fetch('/api/user/' + userId)
        .then(response => response.json())
        .then(user => {
            document.getElementById('profile-name').textContent = user.first_name + ', ' + user.age + ' ans';
            document.getElementById('profile-age-city').textContent = user.city;
            document.getElementById('profile-bio').textContent = user.bio || 'Aucune bio disponible';
            
            // Afficher les centres d'int√©r√™t
            const interestsContainer = document.getElementById('profile-interests');
            interestsContainer.innerHTML = '';
            if (user.interests) {
                user.interests.forEach(interest => {
                    const span = document.createElement('span');
                    span.className = 'bg-primary bg-opacity-10 text-primary text-xs px-2 py-1 rounded-full';
                    span.textContent = interest.name;
                    interestsContainer.appendChild(span);
                });
            }
            
            // Afficher la photo si disponible
            const photoContainer = document.getElementById('profile-photo');
            if (user.profile_photo) {
                photoContainer.innerHTML = `<img src="/static/uploads/${user.profile_photo}" class="w-24 h-24 rounded-full object-cover">`;
            } else {
                photoContainer.innerHTML = '<i class="fas fa-user text-4xl text-gray-400 flex items-center justify-center h-full"></i>';
            }
            
            document.getElementById('profile-modal').classList.remove('hidden');
        });
}

function closeProfileModal() {
    document.getElementById('profile-modal').classList.add('hidden');
}

function unmatch(userId) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer ce match ? Cette action est irr√©versible.')) {
        fetch('/api/unmatch/' + userId, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showFlashMessage('Match supprim√© avec succ√®s', 'success');
                location.reload();
            } else {
                showFlashMessage('Erreur lors de la suppression du match', 'error');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showFlashMessage('Erreur lors de la suppression du match', 'error');
        });
    }
}
</script>
{% endblock %}
